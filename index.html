<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>dragToTable</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" href="css/elementUI.css" />
    <!-- 主css -->
    <link rel="stylesheet" href="css/index.css" />
  </head>
  <body>
    <!-- vue挂载的div -->
    <div id="app">
      <div class="outer-wrap per">
        <div class="content-header" @click="panelShowOrhide=true">
          <el-date-picker
            v-model="form.dateRange"
            type="daterange"
            range-separator="至"
            start-placeholder="开始日期"
            end-placeholder="结束日期"
            size="mini"
          >
          </el-date-picker>
          <el-button type="primary" size="mini" @click="search">查询</el-button>
          <el-button type="success" size="mini" @click="exportSpecialExcel()" class="exportExcel"
            >导出Excel</el-button
          >
        </div>
        <div class="content-body">
          <div class="content-table" @click="panelShowOrhide=true">
            <div
              class="w-table"
              :class="{'w-table_moving': dragState.dragging}"
            >
              <el-table
                :default-sort="{prop: 'date', order: 'descending'}"
                :size="option.size"
                :data="data"
                :border="option.border"
                :height="option.height"
                :max-height="option.maxHeight"
                :style="{ width: parseInt(option.width)+'px' }"
                :cell-class-name="cellClassName"
                :header-cell-class-name="headerCellClassName"
                @sort-change="sortChange"
                @header-dragend="headerDragend"
              >
                <el-table-column
                  slot="fixed"
                  fixed
                  prop="date"
                  label="日期"
                  width="150"
                >
                </el-table-column>
                <el-table-column
                  v-for="(col, index) in tableHeader"
                  :sortable="col.sortable"
                  :key="index"
                  :resizable="col.resizable"
                  :prop="col.prop"
                  :label="col.label"
                  :width="col.width"
                  :type="col.type"
                  :header-align="col.headerAlign"
                  :column-key="index.toString()"
                  :render-header="renderHeader"
                >
                </el-table-column>
              </el-table>
            </div>
          </div>
          <div :class="{'content-pannel':true, panelHide: panelShowOrhide}">
            <div class="fold-button">
              <div
                class="button"
                @click="panelShowOrhide=!panelShowOrhide"
              ></div>
            </div>
            <div class="content">
              <div class="exit" @click="panelShowOrhide=!panelShowOrhide"></div>
              <div class="history">
                <div class="header">
                  <div class="title">布局模板</div>
                  <!-- 注释没删是因为随时可以恢复布局模板的按钮 -->
                  <!-- <el-button
                    class="history-button button"
                    size="small"
                    type="primary"
                    >新建</el-button
                  > -->
                  <!-- <el-button
                    class="history-button button"
                    size="small"
                    type="primary"
                    >另存为</el-button
                  >
                  <el-button
                    class="history-button button"
                    size="small"
                    type="success"
                    >保存</el-button
                  > -->
                </div>
                <div class="history-body">
                  <div class="noList" v-show="!form.historyTemplates.length">
                    暂无布局模板
                  </div>
                  <ul v-show="form.historyTemplates.length">
                    <li
                      v-for="listItem in form.historyTemplates"
                      :key="listItem.id"
                    >
                      <div v-show="listItem.historyLiDotShow" class="dot"></div>
                      <div class="name" @click="liSelected(listItem)">
                        {{listItem.name}}
                      </div>
                      <div class="option">
                        <div
                          class="delete"
                          title="删除"
                          @click.stop="deleteHisTemplate(listItem)"
                        ></div>
                        <div
                          class="edit"
                          title="编辑"
                          @click.stop="editHisTemplate(listItem)"
                        ></div>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div class="column-select">
                <div class="header">
                  <div class="title">列名选择区域</div>
                  <el-button
                    class="col-select-button button"
                    size="small"
                    type="warning"
                    @click="resetTableColumns"
                    >重置</el-button
                  >
                  <el-button
                    class="col-select-button button"
                    size="small"
                    type="primary"
                    @click.stop="save()"
                    >保存</el-button
                  >
                  <!-- 如果布局模板为空,那么另存为置灰处理 -->
                  <el-button
                    class="col-select-button button"
                    size="small"
                    type="primary"
                    @click="saveAs"
                    :disabled="form.historyTemplates.length==0"
                    >另存为</el-button
                  >
                </div>
                <div class="col-select-body">
                  <el-tree
                    :data="form.colSelectData"
                    :default-checked-keys="[0]"
                    :check-on-click-node="true"
                    node-key="id"
                    default-expand-all
                    show-checkbox
                    ref="tree"
                    @check="treeNodeCheck"
                    @check-change="checkChange"
                  >
                  </el-tree>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- 新建和另存为共用一个会话框 -->
      <el-dialog
        :title="panelTitle"
        :visible.sync="dialogShow"
        @close="closeDialog"
        width="30%"
        class="dialog"
      >
        <el-form
          :inline="true"
          label-width="90px"
          :rules="form.rules"
          :model="dialogForm"
          ref="dialogForm"
        >
          <el-form-item prop="input" label="模板名: ">
            <el-input
              v-model="dialogForm.input"
              size="mini"
              class="inputWidth"
              placeholder="请输入模板名"
            ></el-input>
          </el-form-item>
        </el-form>
        <div slot="footer" class="dialog-footer">
          <el-button @click="dialogShow=false" size="mini">取 消</el-button>
          <el-button @click="submit" size="mini">确 定</el-button>
        </div>
      </el-dialog>
    </div>
    <!-- 引入vue,elementUI,axios -->
    <script src="js/vue.js"></script>
    <script src="js/elementUI.js"></script>
    <script src="js/axios.min.js"></script>
    <!-- 统一将发送的请求提取出去 -->
    <script src="./api/query.js"></script>
    <!-- 导出excel的依赖 -->
    <script src="./js/export2Excel/xlsx.core.min.js"></script>
    <script>
        var app = new Vue({
          el: "#app",
          data: {
            // 正在编辑的对象
            edittingItem: null,
            // 会话框的输入框
            dialogForm: {
              input: "",
            },
            // 会话框的显隐
            dialogShow: false,
            selectedItem: null,
            historyLiDotShow: false,
            // 侧滑菜单的显隐
            panelShowOrhide: false,
            // 会话框的标题
            panelTitle: "另存为",
            checked: false,
            form: {
              // 输入框必填
              rules: {
                input: [
                  {
                    validator: this.inputValidate,
                    required: true,
                    trigger: "blur",
                  },
                ],
              },
              // 搜索的日期区间
              dateRange: [],
              // 布局模板列表
              historyTemplates: [
                { name: "2021年8月1日", id: "2", historyLiDotShow: false },
                { name: "2021年8月2日", id: "1", historyLiDotShow: false },
                { name: "2021年8月3日", id: "3", historyLiDotShow: false },
                { name: "2021年8月4日", id: "4", historyLiDotShow: false },
                { name: "2021年8月5日", id: "5", historyLiDotShow: false },
                { name: "2021年8月6日", id: "6", historyLiDotShow: false },
                { name: "2021年8月7日", id: "7", historyLiDotShow: false },
                { name: "2021年8月8日", id: "8", historyLiDotShow: false },
                { name: "2021年8月9日", id: "9", historyLiDotShow: false },
                { name: "2021年8月10日", id: "10", historyLiDotShow: false },
                { name: "2021年8月11日", id: "11", historyLiDotShow: false },
                { name: "2021年8月12日", id: "12", historyLiDotShow: false },
              ],
              /* 
                树形选择区域, 数据结构为数组套对象,每个对象代表一个选项,带有chidren属性都是分类,列名只会取叶子节点(也就是不带children属性的最深层的数据),节点必须包含的属性有:
                  id(树图节点id不能重复),数字
                  label(节点的标题),字符串
                  order(用于保存列的顺序),数字
                  prop(表格列的属性名,用于生成表格数据),字符串
                  sortable(表格列是否可排序),布尔值
                  width(表格列的宽度),数字
                  disabled(是否禁止修改),布尔值
                  checked(是否选中),布尔值
              */
              colSelectData: [
                // 占位的树形结构数据
                {
                  id: 0,
                  label: "日期",
                  order: 0,
                  prop: "date",
                  disabled: true,
                  checked: true,
                  width: 110,
                },
                {
                  id: 1,
                  label: "常用",
                  children: [
                    {
                      id: 4,
                      label: "个人信息",
                      children: [
                        {
                          id: 9,
                          label: "姓名",
                          prop: "name",
                        },
                        {
                          id: 10,
                          label: "性别",
                          prop: "sex",
                        },
                      ],
                    },
                  ],
                },
                {
                  id: 2,
                  label: "工作信息",
                  children: [
                    {
                      id: 5,
                      label: "工作单位",
                      prop: "company",
                    },
                    {
                      id: 6,
                      label: "单位地址",
                      prop: "companyAddress",
                    },
                  ],
                },
                {
                  id: 3,
                  label: "工作性质",
                  children: [
                    {
                      id: 7,
                      label: "工作内容",
                      prop: "work-content",
                    },
                    {
                      id: 8,
                      label: "工作技能",
                      children: [
                        {
                          id: 11,
                          label: "前端",
                          children: [
                            {
                              id: 14,
                              label: "javascript",
                              prop: "js",
                            },
                            {
                              id: 15,
                              label: "html",
                              prop: "html",
                            },
                            {
                              id: 16,
                              label: "css",
                              prop: "css",
                            },
                          ],
                        },
                        {
                          id: 12,
                          label: "后端",
                        },
                      ],
                    },
                  ],
                },
              ],
              defaultProps: {
                children: "children",
                label: "label",
              },
            },
            tableHeadersProps: ["date"],
            tableHeader: [
              {
                prop: "date",
                label: "日期",
                sortable: true,
              },
            ],
            dragState: {
              start: -9, // 起始元素的 index
              end: -9, // 移动鼠标时所覆盖的元素 index
              dragging: false, // 是否正在拖动
              direction: undefined, // 拖动方向
            },
            header: [],
            option: {
              border: true,
              maxHeight: "100%",
              size: "mini",
              height: "100%",
            },
            data: [
              // 表格占位的假数据
              {
                date: "2016-05-03",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "1上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-02",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-04",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-01",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-08",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },

              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
              {
                date: "2016-05-06",
                name: "王小虎",
                province: "上海",
                city: "普陀区",
                address: "上海市普陀区金沙江路 1518 弄",
                zip: 200333,
              },
            ],
          },
          watch: {
            header(val, oldVal) {
              this.tableHeader = val;
            },
          },
          mounted() {
            // 载入后触发获取布局模板的方法
            this.getHistoryList();
          },
          methods: {
            // 将日期转换为yyyy-mm-dd格式
            dateCut(date) {
              let now = new Date(date);
              let y = now.getFullYear();
              let m = now.getMonth() + 1;
              let d = now.getDate();
              m = m.toString().padStart(2, 0);
              d = d.toString().padStart(2, 0);
              return y + "-" + m + "-" + d;
            },
            // 点击查询触发
            search() {
              let startDt = null,
                  endDt = null;
                if(this.form.dateRange){
                  if(this.form.dateRange instanceof Array){
                    if(this.form.dateRange.length != 0){
                      startDt = this.dateCut(this.form.dateRange[0])
                      endDt = this.dateCut(this.form.dateRange[1])
                    }
                  }
                }
                // 参数有开始日期,结束日期,表头都有哪些列
              let params = {
                startDt,
                endDt,
                header: this.tableHeadersProps,
              };
              getTableData(params)
                .then((res) => {
                  if (res) {
                    // 返回的数据绑定给表格
                    this.data = res;
                  }
                })
                .catch((err) => {
                  console.error(new Error("查询失败"));
                });
            },
            // 改变表格的列宽时候调用
            headerDragend(newWidth, oldWidth, column, event) {
              column.width = newWidth;
              let nodes = this.$refs.tree.getCheckedNodes(true, false);
              // 找到改变了列宽的这一列
              let changedWidthCol = this.tableHeader.find(item => {
                if(item.prop == column.property){
                  return true
                }
              })
              // 在拖动时候将列的宽度信息保存至节点中, 直接保留整数
              changedWidthCol.width = newWidth
              nodes.forEach(node => {
                if(node.prop == changedWidthCol.prop){
                  node.width = parseInt(changedWidthCol.width)
                }
              })
            },
            sortChange(column, prop, order) {
            },
            sheet2blob(sheet, sheetName) {
              sheetName = sheetName || "sheet1";
              var workbook = {
                SheetNames: [sheetName],
                Sheets: {},
              };
              workbook.Sheets[sheetName] = sheet;
              // 生成excel的配置项
              var wopts = {
                bookType: "xlsx", // 要生成的文件类型
                bookSST: false, // 是否生成Shared String Table，官方解释是，如果开启生成速度会下降，但在低版本IOS设备上有更好的兼容性
                type: "binary",
              };
              var wbout = XLSX.write(workbook, wopts);
              var blob = new Blob([s2ab(wbout)], {
                type: "application/octet-stream",
              });
              // 字符串转ArrayBuffer
              function s2ab(s) {
                var buf = new ArrayBuffer(s.length);
                var view = new Uint8Array(buf);
                for (var i = 0; i != s.length; ++i)
                  view[i] = s.charCodeAt(i) & 0xff;
                return buf;
              }
              return blob;
            },
            exportSpecialExcel() {
              // 设置导出的excel的列名
              let excelHeader = [];
              let excelHeaderProp = [];
              // 设置导出的excel的表格体
              let excelBody = [];
              this.tableHeader.forEach((header) => {
                excelHeader.push(header.label);
                excelHeaderProp.push(header.prop);
              });
              this.data.forEach((item) => {
                let tempRowData = [];
                excelHeaderProp.forEach((header) => {
                  tempRowData.push(item[header]);
                });
                excelBody.push(tempRowData);
              });
              var aoa = [excelHeader];
              // 表头拼接表格体
              aoa = aoa.concat(excelBody);
              // 注释掉的是引入的导出表格的表头的示例,包含合并表头
              // var aoa = [
              //     ['主要信息', null, null, '其它信息'], // 特别注意合并的地方后面预留2个null
              //     this.tableHeader,
              //     ['张三', '男', 18, new Date()],
              //     ['李四', '女', 22, new Date()]
              // ];
              var sheet = XLSX.utils.aoa_to_sheet(aoa);
              // sheet['!merges'] = [
              //     // 设置A1-C1的单元格合并
              //     { s: { r: 0, c: 0 }, e: { r: 0, c: 2 } }
              // ];

              var tmpDown = this.sheet2blob(sheet, "全部数据");

              var href = URL.createObjectURL(tmpDown); //创建对象超链接
              var aLink = document.createElement("a");
              aLink.href = href; //绑定a标签
              aLink.download = "导出数据.xlsx";
              aLink.click(); //模拟点击实现下载

              setTimeout(function () {
                //延时释放
                URL.revokeObjectURL(tmpDown); //用URL.revokeObjectURL()来释放这个object URL
              }, 100);
            },
            inputValidate(rule, value, callback) {
              if (value === "") {
                callback(new Error("不能为空"));
              }
              this.form.historyTemplates.forEach((template) => {
                if (template.name === value) {
                  callback(new Error("与已有模板名称重复"));
                } else {
                  callback();
                }
              });
            },
            // 点击保存按钮执行的操作
            save() {
              // 如果布局模板无内容, 那么执行新建流程
              if (this.form.historyTemplates.length == 0) {
                this.panelTitle = "新建";
                this.dialogForm.input = "";
                this.dialogShow = true;
              } else {
                let params = { id: this.selectedItem.id, colSelectData: this.form.colSelectData, };
                submitSave(params)
                  .then((res) => {
                    this.$message({
                      type: "success",
                      message: "保存成功!",
                    });
                    // 因为需要获得后台返回的id, 所以重新发起列表请求
                    getHistoryList().then(res=>{
                      this.form.historyTemplate = res
                    })
                  })
                  .catch((err) => {
                    console.error("保存失败");
                  });
              }
            },
            // 关闭会话框时调用, 清空输入框
            closeDialog() {
              setTimeout(() => {
                this.$nextTick(() => {
                  this.$refs["dialogForm"].resetFields();
                });
              });
            },
            // 点击会话框的确定时触发
            submit() {
              this.$refs["dialogForm"].validate((valid) => {
                if (valid) {
                  let params = {
                    name: this.saveAsName,
                  };
                  // 如果是另存为窗口的确定
                  if (this.panelTitle === "另存为") {
                    params = {
                      name: this.saveAsName,
                      colSelectData: this.form.colSelectData,
                    };
                    submitSaveAs(params)
                      .then((res) => {
                        this.dialogShow = false;
                        // 去掉所有的布局模板的小圆圈标识
                        this.form.historyTemplates.forEach((historyTemplate) => {
                          historyTemplate.historyLiDotShow = false;
                        });
                        // 布局模板在第一项插入一条数据
                        this.form.historyTemplates.unshift({
                          name: this.dialogForm.input,
                          id: res.id,
                          historyLiDotShow: true,
                        });
                      })
                      .catch();
                      // 如果是编辑窗口的确定
                  } else if (this.panelTitle === "编辑") {
                    submitEdit(params)
                      .then((res) => {
                        // 从返回的数据中的标识判断是否修改成功
                        if (res) {
                          this.dialogShow = false;
                          this.$message({
                            type: "success",
                            message: "修改成功!",
                          });
                          this.edittingItem.name = this.dialogForm.input;
                          this.$nextTick(() => {
                            this.$refs["dialogForm"].resetFields();
                          });
                        } else {
                          this.dialogShow = true;
                          this.$message({
                            type: "warning",
                            message: "修改失败!",
                          });
                        }
                      })
                      .catch((err) => {
                        console.error("修改失败", err);
                      });
                      // 否则是保存窗口的确定
                  } else {
                    let params = {
                      name: this.dialogForm.input,
                      cols: this.tableHeader,
                    };
                    submitSave(params)
                      .then((res) => {
                        this.dialogShow = false;
                        this.$message({
                          type: "success",
                          message: "保存成功!",
                        });
                      })
                      .catch((err) => {
                        console.error("保存失败", err);
                      });
                  }
                }
              });
            },
            saveAs() {
              this.panelTitle = "另存为";
              this.dialogShow = true;
            },
            // 获取布局模板, 默认选中第一个模板
            getHistoryList() {
              getHistoryList()
                .then((res) => {
                  // this.form.historyTemplates = res.data
                  this.form.historyTemplates[0].historyLiDotShow = true;
                  this.selectedItem = this.form.historyTemplates[0];
                  let params = {
                    id: this.form.historyTemplates[0].id
                  }
                  getTemplateList(params).then(res=>{
                    // this.form.colSelectData = res.xxx
                  })
                  // }
                  // }
                })
                .catch((err) => {
                  // this.form.historyTemplates[0].historyLiDotShow = true
                });
            },
            // 点击不同的布局模板会提示是否切换模板,如果确定切换,就会发起获取树形结构数据的请求
            liSelected(e) {
              this.selectedItem = e;
              let params = {
                id: e.id,
              };
              this.$confirm("是否切换模板?", "提示", {
                confirmButtonText: "确定",
                cancelButtonText: "取消",
                type: "info",
              })
                .then(() => {
                  // 发起获取树形结构数据的请求, 参数为点击的布局模板的id
                  getTemplateList(params)
                    .then((res) => {
                      // 将返回的树形数据赋值
                      this.form.colSelectData = [
                        {
                          id: 0,
                          label: "日期",
                          width: "",
                          order: 0,
                          prop: "date",
                          disabled: true,
                          checked: true,
                        },
                      ];
                      // 遍历所有布局模板, 取消小圆圈的标记
                      this.form.historyTemplates.forEach((historyTemplate) => {
                        historyTemplate.historyLiDotShow = false;
                      });
                      // 将选中的行的小圆圈加上
                      e.historyLiDotShow = true;
                      // this.colSelectData = res.data
                    })
                    .catch((err) => {
                      console.log(err);
                    });
                })
                .catch(() => {});
            },
            // 选中或取消列名选择区域的每一个节点都会触发
            checkChange(e, f) {
              // 利用定时器作为宏任务,等待栈中函数执行完毕后还原checked,防止elementUI自带方法多次触发造成程序混乱,选中或取消只会触发一次
              if (!this.checked) {
                this.tableHeader = this.$refs.tree.getCheckedNodes(true, false);
                let tempHeader = [];
                // 根据叶子节点的order属性排序,还原列的顺序
                for (let i = 0; i < this.tableHeader.length; i++) {
                  if (typeof this.tableHeader[i].order === "number") {
                    tempHeader = this.tableHeader.sort((a, b) => {
                      return a.order - b.order;
                    });
                  } else {
                    // tempHeader.push(this.tableHeader[i])
                  }
                }
                // 根据叶子节点改变表格的列
                this.tableHeader = tempHeader;
                // 为所有的列添加排序
                this.tableHeader.forEach(item => {
                  item.sortable = true
                })
                this.checked = true;
              }
              setTimeout(() => {
                this.checked = false;
              }, 100);

              // let cols = this.$refs.tree.getCheckedNodes(true, false);
              // cols.forEach((item) => {
              //   if (
              //     !this.tableHeader.some((header) => header.prop == item.prop)
              //   ) {
              //     item.checked = false;
              //   }
              // });
              // cols.forEach((col) => {
              //   if (col.checked) {
              //     return false;
              //   }
              //   if (col.order) {
              //     this.tableHeader.splice(col.order, col);
              //     col.checked = true;
              //   } else {
              //     this.tableHeader.push(col);
              //     col.checked = true;
              //   }
              // });
              // this.tableHeader = this.$refs.tree.getCheckedNodes(true,false)
              // 因为涉及强制渲染elementUI的表格, 导致列变动,高度改变,这里强制每次渲染后利用定时器,将高度拉满
              document.getElementsByClassName;
              setTimeout(() => {
                document.getElementsByClassName(
                  "el-table__body-wrapper"
                )[0].style.height = "100%";
                document.getElementsByClassName(
                  "el-table__body-wrapper"
                )[0].style.width = "100%";
              }, 200);
            },
            // 点击编辑会调用
            editHisTemplate(item) {
              this.panelTitle = "编辑";
              this.dialogShow = true;
              this.dialogForm.input = item.name;
              this.edittingItem = item;
            },
            // 点击垃圾桶删除会调用
            deleteHisTemplate(item) {
              this.$confirm("此操作将删除该模板, 是否继续?", "提示", {
                confirmButtonText: "确定",
                cancelButtonText: "取消",
                type: "warning",
              })
                .then(() => {
                  // 删除操作传递的参数为点击的行的id
                  let params = {
                    id: item.id,
                  };
                  deleteHisTemplate(params)
                    .then((res) => {
                      // 这里可以加校验, 如果res中的反馈信息为xxx,就执行删除操作,或执行其他操作
                      this.$message({
                        type: "success",
                        message: "删除成功!",
                      });
                      // 获取点击的行的索引
                      let index = this.form.historyTemplates.findIndex(item=>{
                        return item.id == params.id
                      })
                      // 删除这一行
                      this.form.historyTemplates.splice(index,1)
                    })
                    .catch((err) => {
                      console.log(err);
                      this.$message({
                        type: "warning",
                        message: "删除失败",
                      });
                    });
                })
                .catch(() => {
                  this.$message({
                    type: "info",
                    message: "已取消删除",
                  });
                });
            },
            treeNodeCheck(e, status) {},
            // 重置树型结构数据区域,也是重置表格的列
            resetTableColumns() {
              let nodes = this.$refs.tree.getCheckedNodes(true, false);
              nodes.forEach((node, index) => {
                if (index != 0) {
                  node.order = null;
                }
              });
              // tempData.forEach((item, index) => {
              //   item.order = index;
              //   nodes.forEach((node, index) => {
              //     if (node.prop === item.prop) {

              //       node.order = item.order;
              //       console.log("node.prop",node.prop,"node.order",node.order)
              //     }
              //   });
              //   // let foundChild = findChild(item);
              //   // foundChild.order = index;
              // });

              // this.tableHeader = tempData;
              this.$refs.tree.setCheckedKeys([0]);
            },
            renderHeader(createElement, { column }) {
              return createElement(
                "div",
                {
                  class: ["thead-cell"],
                  on: {
                    mousedown: ($event) => {
                      this.handleMouseDown($event, column);
                    },
                    mousemove: ($event) => {
                      this.handleMouseMove($event, column);
                    },
                  },
                },
                [
                  // 添加 <a> 用于显示表头 label
                  createElement("a", column.label),
                  // 添加一个空标签用于显示拖动动画
                  createElement("span", {
                    class: ["virtual"],
                  }),
                ]
              );
            },
            // 按下鼠标开始拖动
            handleMouseDown(e, column) {
              this.dragState.dragging = true;
              this.dragState.start = parseInt(column.columnKey);
              // 给拖动时的虚拟容器添加宽高
              let table = document.getElementsByClassName("w-table")[0];
              let virtual = document.getElementsByClassName("virtual");
              for (let item of virtual) {
                item.style.height = table.clientHeight - 1 + "px";
                item.style.width =
                  item.parentElement.parentElement.clientWidth + "px";
              }
              document.addEventListener("mouseup", this.handleMouseUp);
            },

            // 鼠标放开结束拖动
            handleMouseUp() {
              this.dragColumn(this.dragState);
              // 初始化拖动状态
              this.dragState = {
                start: -9,
                end: -9,
                dragging: false,
                direction: undefined,
              };
              document.removeEventListener("mouseup", this.handleMouseUp);
            },

            // 拖动中
            handleMouseMove(e, column) {
              if (this.dragState.dragging) {
                let index = parseInt(column.columnKey); // 记录起始列
                if (index - this.dragState.start !== 0) {
                  this.dragState.direction =
                    index - this.dragState.start < 0 ? "left" : "right"; // 判断拖动方向
                  this.dragState.end = parseInt(column.columnKey);
                } else {
                  this.dragState.direction = undefined;
                }
              } else {
                return false;
              }
            },

            // 拖动易位
            dragColumn({ start, end, direction }) {
              let tempData = [];
              let left = direction === "left";
              let right = direction === "right";
              let min = left ? end : start - 1;
              let max = left ? start + 1 : end;
              for (let i = 0; i < this.tableHeader.length; i++) {
                if (i === end) {
                  tempData.push(this.tableHeader[start]);
                } else if (i > min && i < max) {
                  tempData.push(this.tableHeader[left ? i - 1 : i + 1]);
                } else if (!left && !right) {
                  return false;
                } else {
                  tempData.push(this.tableHeader[i]);
                }
              }
              let nodes = this.$refs.tree.getCheckedNodes(true, false);
              tempData.forEach((item, index) => {
                item.order = index;
                // 在拖动时候将列名的顺序信息保存至节点中
                nodes.forEach((node, index) => {
                  if (node.prop === item.prop) {
                    node.order = item.order;
                  }
                });
              });
              this.tableHeader = tempData;
              this.tableHeader.forEach(item => {
                item.sortable = true
              })
            },
            headerCellClassName({ column, columnIndex }) {
              let active =
                columnIndex === this.dragState.end
                  ? `darg_active_${this.dragState.direction}`
                  : "";
              let start =
                columnIndex === this.dragState.start ? `darg_start` : "";
              return `${active} ${start}`;
            },

            cellClassName({ column, columnIndex }) {
              return columnIndex === this.dragState.start ? `darg_start` : "";
            },
            tableHeaderClick(column, event) {},
            tableCellHover(row, column, cell, event) {},
          },
        });
    </script>
  </body>
</html>
